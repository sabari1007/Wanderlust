<% layout('layouts/boilerplate') %>

<style>
  #filters {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
  }

  .filter {
    text-align: center;
    margin-right: 1rem;
    margin-top: 1rem;
    opacity: 0.7;
    cursor: pointer;
  }

  .filter:hover {
    opacity: 1;
    color: black;
  }

  .listing-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    position: relative;
  }

  .listing-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
  }

  .wishlist-icon {
    position: absolute;
    top: 10px;
    right: 15px;
    z-index: 10;
    font-size: 1.2rem;
    color: white;
  }

  .wishlist-icon.active {
    color: red;
  }

  .card-title {
    font-size: 1rem;
    font-weight: 600;
  }

  .card-meta {
    font-size: 0.85rem;
    color: #717171;
  }

  .card-price {
    font-size: 0.95rem;
    font-weight: 600;
  }

  .per-night {
    font-size: 0.85rem;
    color: #717171;
  }

  .price-toggle {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
  }
</style>

<!-- FILTER BAR -->
<div id="filters">
  <div class="filter"><i class="fa-solid fa-fire"></i><p>Trending</p></div>
  <div class="filter"><i class="fa-solid fa-bed"></i><p>Rooms</p></div>
  <div class="filter"><i class="fa-solid fa-igloo"></i><p>Domes</p></div>
<div class="filter">
  <div><i class="fa-solid fa-person-swimming"></i></div>
  <p>Amazing pools</p>
</div>

<div class="filter">
  <div><i class="fa-solid fa-tree"></i></div>
  <p>Nature</p>
</div>

<div class="filter">
  <div><i class="fa-solid fa-tractor"></i></div>
  <p>Farms</p>
</div>

<div class="filter">
  <div><i class="fa-solid fa-snowflake"></i></div>
  <p>Arctic</p>
</div>

<div class="filter">
  <div><i class="fa-solid fa-ship"></i></div>
  <p>Boats</p>
</div>

<div class="filter">
  <div><i class="fa-solid fa-umbrella-beach"></i></div>
  <p>Beachfront</p>
</div>

<div class="filter">
  <div><i class="fa-solid fa-mountain-sun"></i></div>
  <p>Mountain views</p>
</div>

<div class="filter">
  <div><i class="fa-solid fa-fire-burner"></i></div>
  <p>Cabins</p>
</div>




  <!-- GST TOGGLE -->
  <div class="price-toggle">
    <input type="checkbox" id="gstToggle" aria-label="Toggle GST price">
    <span class="toggle-text">Show price with GST</span>
  </div>
</div>

<% if (allListings.length === 0) { %>
  <div class="alert alert-warning text-center mt-3">
    No listings found.
  </div>
<% } %>

<!-- SORT -->
<div class="d-flex mb-3 mt-3">
  <form method="GET" action="/listings" class="ms-auto">
    <% if (searchQuery) { %>
      <input type="hidden" name="q" value="<%= searchQuery %>">
    <% } %>

    <select name="sort" class="form-select" onchange="this.form.submit()">
      <option value="">Sort by</option>
      <option value="price_asc" <%= sort === 'price_asc' ? 'selected' : '' %>>
        Price: Low ‚Üí High
      </option>
      <option value="price_desc" <%= sort === 'price_desc' ? 'selected' : '' %>>
        Price: High ‚Üí Low
      </option>
      <option value="rating" <%= sort === 'rating' ? 'selected' : '' %>>
        Rating
      </option>
    </select>
  </form>
</div>

<!-- LISTINGS -->
<div class="row row-cols-lg-3 row-cols-md-2 row-cols-sm-1 mt-3">
  <% for (let listing of allListings) { %>

    <div class="col mb-4">
      <div class="listing-card">

        <!-- WISHLIST -->
        <div class="wishlist-icon">
          <i class="fa-regular fa-heart"></i>
        </div>

        <a href="/listings/<%= listing._id %>" class="listing-link text-decoration-none text-dark">
          <img
            src="<%= listing.image.url %>"
            class="card-img-top"
            alt="listing image"
            loading="lazy"
          />

          <div class="card-body">
            <p class="card-title mb-1"><%= listing.title %></p>

            <p class="card-meta mb-1">
              ‚≠ê <%= listing.rating || "4.8" %> ¬∑ üìç <%= listing.location %>
            </p>

            <p
              class="card-price"
              data-base="<%= listing.price %>"
              data-gst="<%= Math.round(listing.price * 1.18) %>">

              ‚Çπ <span class="price-value">
                <%= listing.price.toLocaleString("en-IN") %>
              </span>

              <span class="per-night">/ night</span>
            </p>
          </div>
        </a>
      </div>
    </div>

  <% } %>
</div>

<!-- GST SCRIPT -->
<script>
  const toggle = document.getElementById("gstToggle");
  const text = document.querySelector(".toggle-text");

  toggle.addEventListener("change", () => {
    document.querySelectorAll(".card-price").forEach(priceEl => {
      const base = priceEl.dataset.base;
      const gst = priceEl.dataset.gst;
      const valueEl = priceEl.querySelector(".price-value");

      valueEl.textContent = toggle.checked
        ? Number(gst).toLocaleString("en-IN")
        : Number(base).toLocaleString("en-IN");
    });

    text.textContent = toggle.checked
      ? "Showing price with GST"
      : "Show price with GST";
  });
</script>

<!-- WISHLIST SCRIPT -->
<script>
  document.querySelectorAll(".wishlist-icon").forEach(icon => {
    icon.addEventListener("click", e => {
      e.stopPropagation();
      icon.classList.toggle("active");

      const heart = icon.querySelector("i");
      heart.classList.toggle("fa-regular");
      heart.classList.toggle("fa-solid");
    });
  });
</script>
